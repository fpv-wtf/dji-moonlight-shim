#!/system/bin/sh

set -euo pipefail

# Figure out which glasses service we have to toggle.

DEVICE=$(getprop ro.product.device)
IS_V2=$(echo $DEVICE | grep -c "wm170_gls")

if [ $IS_V2 -eq 1 ]; then
  GLASSES_SERIVCE="dji.glasses_wm150_service"
else
  GLASSES_SERIVCE="dji.glasses_service"
fi

# Check if we should use USB mode.

set +e # don't choke if something goes wrong with package-config

USE_USB_MODE=$(package-config get dji-moonlight-shim use_usb_mode)
if [ $USE_USB_MODE = "true" ]; then
  echo "USB mode has been enabled via package-config."
  USE_USB_MODE=1
else
  USE_USB_MODE=0
fi

set -e

# Construct the shim arguments. If this script is called with arguments, pass
# them, otherwise pass --net or --usb depending on the package config.

if [ $# -eq 0 ]; then
  if [ $USE_USB_MODE -eq 1 ]; then
    SHIM_ARGS="--usb"
  else
    SHIM_ARGS="--net"
  fi
else
  SHIM_ARGS="$@"
fi

# Start the shim.

trap "setprop $GLASSES_SERIVCE 1" EXIT

setprop $GLASSES_SERIVCE 0
sleep 3

cd /opt/moonlight
./dji-moonlight-shim $SHIM_ARGS

setprop $GLASSES_SERIVCE 1
